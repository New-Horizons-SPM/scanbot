<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Julian Ceddia">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Hooks - Scanbot</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Scanbot</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../featured/" class="nav-link">Featured</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Configuration <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../web-app/#configuration" class="dropdown-item">Web App</a>
</li>
                                    
<li>
    <a href="../configuration/" class="dropdown-item">Terminal/Zulip</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../web-app/" class="dropdown-item">Web App</a>
</li>
                                    
<li>
    <a href="../commands/" class="dropdown-item">Terminal/Zulip</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../automation/" class="nav-link">Automation</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">Hooks</a>
                            </li>
                            <li class="navitem">
                                <a href="../about/" class="nav-link">About</a>
                            </li>
                            <li class="navitem">
                                <a href="../contact/" class="nav-link">Contact</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                            <li class="nav-item">
                                <a rel="prev" href="../automation/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../about/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="https://github.com/New-Horizons-SPM/scanbot/edit/master/docs/hooks.md" class="nav-link"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#hooks" class="nav-link">Hooks</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#hk_light" class="nav-link">hk_light</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#hk_survey" class="nav-link">hk_survey</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#hk_classifier" class="nav-link">hk_classifier</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#hk_tipshape" class="nav-link">hk_tipShape</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#hk_commands" class="nav-link">hk_commands</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<html><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-JDY58YVQ1F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JDY58YVQ1F');
</script>
</head><body><h1 id="hooks">Hooks</h1>
<p><a href="https://www.rswebsols.com/tutorials/programming/software-development-hook-hooking">Hooks</a> allow you to add or replace key components of Scanbot's functionality where system-specific customisation is required.
The ability to do this without rewriting source code means you can pull Scanbot updates without losing your custom functionality. For example, Scanbot monitors a camera feed when tracking the motion of the STM
head during automated operation; a task that may require a light to be switched on or off at times. Obviously, the code needed to achieve this will vary from system to system. This is where the user-written hook
<code>hk_light.py</code> would be called by Scanbot to perform such a task. This page details all the hooks currently available to Scanbot. Feel free to raise an issue on the GitHub page if you require a hook at a certain
point in Scanbot's source code. All hooks must be saved in the directory ~/scanbot/scanbot/</p>
<h2 id="hk_light">hk_light</h2>
<p>This hook is called by any function that requires control over the STM light when monitoring the camera feed.</p>
<ul>
<li>Inputs: None</li>
<li>Outputs: None</li>
<li>Error handling: Raise an <code>Exception</code> if unable to turn the light on or off</li>
</ul>
<p>Structure:
hk_light.py must contain two functions: <code>turn_on</code> and <code>turn_off</code>. An example is shown below:</p>
<pre><code class="language-Python">def turn_on():
    # Code to turn light on
    # If unsuccessful:
        # Raise Exception
    # If successful:
    print("Light on!")

def turn_off():
    # Code to turn light off
    # If unsuccessful:
        # Raise Exception
    # If successful:
    print("Light off!")
</code></pre>
<p><br></p>
<h2 id="hk_survey">hk_survey</h2>
<p>This hook can be called at the completion of every scan in a <code>survey</code> or <code>survey2</code> when the <code>-hk_survey</code> option is set.</p>
<ul>
<li>Inputs:<ol>
<li>Raw scan data</li>
<li>.sxm filename</li>
<li>A Python dictionary containing metadata about the scan</li>
</ol>
</li>
<li>Outputs: None</li>
<li>Error handling: None</li>
</ul>
<p>Structure:
hk_survey.py must contain the function <code>run</code>. An example is shown below:</p>
<pre><code class="language-Python">def run(scan_data,filename,metadata):
    # Code to process the image (e.g. plane fit, filtering, etc.)
    # Code to save the image or send the image to a server
    # Code to do anything you want
</code></pre>
<h2 id="hk_classifier">hk_classifier</h2>
<p>This hook can called at the completion of every scan in a <code>survey</code> or <code>survey2</code> when the <code>-autotip</code> and <code>-hk_classifier</code> options are set.
Its purpose is to use an alternative image classifier when assessing the quality of completed STM images and to decide when Scanbot should reshape the tip.</p>
<ul>
<li>Inputs:<ol>
<li>Raw scan data</li>
<li>.sxm filename</li>
<li>Record of all previous classifications - a list of dictionaries</li>
</ol>
</li>
<li>Outputs:<ol>
<li>A python dictionary containing classification labels. The only mandatory label is "tipShape". This is what tells Scanbot whether to execute a tip shape or not.</li>
</ol>
</li>
<li>Error handling: None</li>
</ul>
<p>Structure: hk_classifier.py must contain the function <code>run</code>. An example is shown below:</p>
<pre><code class="language-Python">def run(scan_data,filename,classification_hist):
    # Code to process the image (e.g. plane fit, filtering, etc.)

    # API call to external classifier (e.g. AI agent)

    classification = {"tipChanges": &lt;output from classifier&gt;,   # Example trait to keep track of
                      "unstable": &lt;output from classifier&gt;,     # Example trait to keep track of
                      "multipleTips": &lt;output from classifier&gt;, # Example trait to keep track of

    # Check the classification history to see if we've had a bad run of images

    if(num_bad_images &gt; threshold):
        classification["tipShape"] = True                       # Tell Scanbot to reshape the tip
    else:
        classification["tipShape"] = False                      # Tell Scanbot not to reshape the tip

    return classification
</code></pre>
<h2 id="hk_tipshape">hk_tipShape</h2>
<p>This hook can be called from the auto_tip_shape command, prior to performing a tip shaping action, when the <code>-hk_tipShape</code> option is set.
Its purpose is to adjust the tip shaping parameters based on either the image of the tip's imprint or the size and symmetry scores assigned to the imprint by Scanbot.</p>
<ul>
<li>Inputs:<ol>
<li>Image of the region prior to making the imprint</li>
<li>Image of the tip's imprint</li>
<li>1D array containing all the tip shaping properties. See <a href="https://github.com/New-Horizons-SPM/nanonisTCP">nanonisTCP.TipShaper</a>.</li>
<li>Array containing target size (nm2 - smaller = better) and circularity (0 = asymmetric, 1 = perfect circle) scores of the imprint.</li>
<li>Array containing actual size and circularity scores assigned by Scanbot</li>
<li>history: a variable to pass anything out at the end of the function, which will be passed back in on the next iteration. This is a way to keep track of what's happened in previous attempts.</li>
</ol>
</li>
<li>Outputs:<ol>
<li>1D array containing the modified tip shaping parameters.</li>
<li>History variable that contains anything you would like to keep track of. This will be passed back into the hook on the next iteration.</li>
</ol>
</li>
<li>Error handling: None</li>
</ul>
<p>Structure: hk_tipShape.py must contain the funtion <code>run</code>. An example is show below:</p>
<pre><code class="language-Python">def run(cleanImage, tipImprint, tipShapeProps, target, actual, history):
    # Code to filter tipImprint

    # API call to RL Agent passing in tipImprint and history to determine next tip-shaping parameters.

    # Adjust relevant tip shaping parameters
    tipShapeProps[3] = agent.z1     # Amount to plunge the tip into the surface (m)
    tipShapeProps[5] = agent.bias   # Bias applied while the tip is in the suface (V)
    tipShapeProps[7] = agent.z2     # Amount to pull tip out of the surface (m)

    record = {"z1": agent.z1,       # Make a record of this tip-shaping attempt
              "bias": agent.bias,
              "z2": agent.z2,
              "imprint": agent.imprint)

    history.append(record)          # Append it to the running history so it can be taken into account on the next iteration

    return tipShapeProps, history   # Return the updated tip shaping properties
</code></pre>
<h2 id="hk_commands">hk_commands</h2>
<p>This hook is used to implement custom written commands into Scanbot. To enable it, set <code>hk_commands=1</code> in <code>scanbot_config.ini</code>.
Commands in hk_commands.py that have the same name as any existing Scanbot command will take priority.</p>
<p>Structure: hk_commands.py must contain the class <code>hk_commands</code> and contain the class variable <code>commands</code>. <code>commands</code> is a python dictionary
that maps the command name (key), as called by the user, to the function that handles it.</p>
<p>Scanbot commands can be run either in the main thread or in a separate thread. The below Python code shows the implementation of two similar commands,
the first, <code>change_bias</code>, is a scenario where threading may be unnecessary, while in the second, <code>change_bias2</code>, it could be useful.
To test this script:</p>
<ol>
<li>Set <code>hk_commands=1</code> in <code>scanbot_config.ini</code></li>
<li>Copy and paste the below code to ~/scanbot/scanbot/hk_commands.py</li>
<li>Restart Scanbot <code>python scanbot_interface.py -c</code></li>
<li>Try running <code>help change_bias</code> or simply <code>change_bias -V=1</code></li>
</ol>
<p><strong>hk_commands.py</strong></p>
<pre><code class="language-Python">from nanonisTCP.Bias import Bias                                                # Import the NanonisTCP Bias Module. Used to control the tip bias
import global_                                                                  # Import the global variables
import time                                                                     # Import time for sleeping

class hk_commands(object):
    def __init__(self,interface):                                               # Set up the constructor like this
        self.interface = interface                                              # Reference to scanbot_interface
        self.initCommandDict()                                                  # Initialise the dictionary containing a list of custom commands

    def initCommandDict(self):
        self.commands = {                                                       # A dictionary that maps commands with function names.
                         'change_bias'  : self.changeBias,                      # An example command without threading. Here, the user will call change_bias
                         'change_bias2' : self.changeBias2,                     # An example command with threading. Here, the user will call change_bias2
                         }

    def changeBias(self,user_args,_help=False):
        """
        This function changes the bias in Nanonis. It performs this task
        without the use of multi-threading which means it cannot Scanbot will
        be busy until the task is complete. This is fine for commands that will
        not interfere with other threaded tasks (e.g. taking control of the 
        motors while a survey is running). Tasks that are not threaded can run
        while a threaded task is already running. Tasks that are not threaded
        cannot be stopped until complete (i.e. running 'stop' command will not
        work).

        Parameters
        ----------
        user_args : arguments passed in by the user when calling the command
        _help     : flag set when user calls "help change_bias"

        """
        arg_dict = {'-V'    : ['0',        lambda x: float(x), "(float) Set the tip bias."],
                    '-arg2' : ['some str', lambda x: str(x),   "(str) An example user argument that defaults to 'some str' is a string."]}

        if(_help): return arg_dict                                              # This will get called when the user runs the command 'help exUnthreaded'

        error,user_arg_dict = self.interface.userArgs(arg_dict,user_args)       # This will validate args V and arg2 as float() and str(), respectively
        if(error):
            return error + "\nRun ```help change_bias``` if you're unsure."     # Inform the user of any errors in their input

        V,arg2 = self.interface.unpackArgs(user_arg_dict)                       # Unpack the arguments

        if(V == 0):                                                             # Validation
            errorMessage = "Cannot set bias to zero!"
            return errorMessage                                                 # Return with error

        NTCP,connection_error = self.interface.scanbot.connect()                # Connect to nanonis via TCP
        if(connection_error):
            return connection_error                                             # Return error message if there was a problem connecting        

        biasModule = Bias(NTCP)                                                 # The NanonisTCP Bias module
        biasModule.Set(V)                                                       # Set the bias in Nanonis

        self.interface.sendReply("Bias set to " + str(V) + "! arg2 = " + arg2)  # This is how you send a reply.

        self.interface.scanbot.disconnect(NTCP)                                 # Remember to free up the TCP port

        return                                                                  # Return None for success

    def changeBias2(self,user_args,_help=False):
        """
        This function will change the bias in Nanonis by threading the function
        "threadedFunction" after validating user input. Only one threaded
        function can run at a time. If the user tries to run a second threaded
        function, they will be presented with an error. This is handled by the
        global flags in global_. Threaded tasks run in the background and can
        be stopped by the user running the "stop" command.

        Parameters
        ----------
        user_args : arguments passed in by the user when calling the command
        _help     : flag set when user calls "help change_bias2"

        """
        arg_dict = {'-V'    : ['0',  lambda x: float(x), "(float) Set the tip bias."],
                    '-wait' : ['10', lambda x: int(x),   "(int) Seconds to wait after changing bias."]}

        if(_help): return arg_dict                                              # This will get called when the user runs the command 'help exUnthreaded'

        error,user_arg_dict = self.interface.userArgs(arg_dict,user_args)       # This will validate args V and wait as float() and int(), respectively
        if(error):
            return error + "\nRun ```help change_bias2``` if you're unsure."    # Inform the user of any errors in their input

        args = self.interface.unpackArgs(user_arg_dict)                         # Unpack the arguments

        func = lambda : self.threadedFunction(*args)                            # Handle to the function to be threaded
        return self.interface.threadTask(func)                                  # Return and thread the function

    def threadedFunction(self,V,wait):
        """
        This function changes the bias in Nanonis and then waits a specified
        amount of time.

        This function is run on a new thread. It will run in the backgound 
        while Scanbot can still reveive commands. It should periodically check
        event flags by calling 'self.interface.scanbot.checkEventFlags()'. If
        True is returned, the 'stop' function has been called by the user.
        Whenever returning, the global running flag should be cleared by 
        calling global_.running.clear().

        Parameters
        ----------
        V    : Change the bias to this value
        wait : Wait this many seconds after changing the bias

        """
        if(V == 0):                                                             # Validation
            errorMessage = "Cannot set bias to zero!"
            global_.running.clear()                                             # Free up the running flag. This must be done whenever exiting a threaded function
            return errorMessage                                                 # Return with error

        NTCP,connection_error = self.interface.scanbot.connect()                # Connect to nanonis via TCP
        if(connection_error):
            global_.running.clear()                                             # Free up the running flag. This must be done whenever exiting a threaded function
            return connection_error                                             # Return error message if there was a problem connecting        

        biasModule = Bias(NTCP)                                                 # The NanonisTCP Bias module
        biasModule.Set(V)                                                       # Set the bias in Nanonis

        self.interface.sendReply("Bias set to " + str(V))                       # This is how you send a reply.

        self.interface.sendReply("Waiting " + str(wait) + " seconds...")        # This is how you send a reply.

        seconds = 0
        while(seconds &lt; wait):
            time.sleep(1)
            seconds += 1                                                        # Keep track of how many seconds have gone by
            if(self.interface.scanbot.checkEventFlags() == True):               # Periodically check event flags when appropriate to see if the user has called "stop"
                self.interface.sendReply("Stopping early!")                     # This is how you send a reply.
                break

        self.interface.sendReply("Done!")                                       # This is how you send a reply.

        self.interface.scanbot.disconnect(NTCP)                                 # Remember to free up the TCP port
        global_.running.clear()                                                 # Free up the running flag. This must be done whenever exiting a threaded function

        return
</code></pre></body></html></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
